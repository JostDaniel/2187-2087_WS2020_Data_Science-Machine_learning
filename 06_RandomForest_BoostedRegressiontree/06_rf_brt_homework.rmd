---
title: "Random Forests and Boosted Regression Trees - Homework"
author: "GROUP 4: Leonard Fidlin (h01352705), Daniel Jost (h01451889), Anne Valder (h11928415)"
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
editor_options: 
  chunk_output_type: inline

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = 'center')

```

<br>

**This assignment is due on December 7.**

**Please use the corresponding R Markdown file to save your results in an HTML file. Then upload the HTML file to learn.wu.ac.at.**

<br>


# Input data

Install and load the required packages.

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}

# Load packages
library(plyr)
library(tidyverse)
library(data.table)
library(fst)
library(ranger)
library(xgboost)
library(caret)
library(viridis)

```

Adjust the data path and load the input data.

```{r}

# Set wd to Set the path to the data
data_path = "."

# Read input data on municipal level for the whole country
col_input = read_fst(file.path(data_path, "data", "colombia_input.fst"))

# Read input data on grid level for the department Quindío
quindio_grid = read_fst(file.path(data_path, "data", "quindio_input_grid.fst"))

```

# Data Visualization and Exploratory Data Analysis

## Exercise 1

Use the input data for Colombia on the municipal level (colombia_input.fst) for this exercise.

### 1.1

Create a plot that shows the distribution of the population density (raster_pop_100). Briefly describe what you see.

```{r}

col_input %>% 
  ggplot(aes(x=raster_pop_100)) +
  geom_histogram(binwidth = 0.5)  +
  theme_classic()

col_input %>% 
  summarize(mean(raster_pop_100, na.rm = T), median(raster_pop_100, na.rm = T))

```
As can be seen in the plot, most grids have a rather low population density (below 10 inhabitants per 100m^2). In fact half of the grids have a population density below 0.44 inhabitants per 100m^2. To better visualize the distribution close to the origin we limit the scale of the x-axis to 10.

```{r}
col_input %>% 
  ggplot(aes(x=raster_pop_100)) +
  geom_histogram(binwidth = 0.05)  +
  scale_x_continuous(limit = c(0,10)) +
  theme_classic()

```

Here we can better see the distribution of the population density close to the origin (but do not see grids with a population density above 10 inhabitants per grid)

### 1.2

Create a plot that visualizes the relationship between the population density (raster_pop_100) and the light intensity recorded at night (night_lights_100). Combine two suitable geom functions in one plot. Briefly describe what you see.

```{r}

col_input %>% 
  ggplot(aes(x=raster_pop_100, y=night_lights_100, color = night_lights_100)) + 
  geom_point() + 
  geom_smooth() +
  theme_classic()

```
As expected, this plot suggests a positive relationship of population density and night lights at the grid level. On average, a higher population density correlates with more light at night.

## Exercise 2

Use the grid-level input data for Quindío (quindio_input_grid.fst) for this exercise.

### 2.1

Create a plot the shows the distribution of the light intensity at night (night_lights_100). Include information on whether or not a grid lies inside a protected area (protected_areas_100). Briefly describe what you see.

Hint: Transform the variable protected_areas_100 to character inside the ggplot or the geom function.

```{r}

quindio_grid %>% 
  ggplot(aes(x=night_lights_100, fill = as.character(protected_areas_100),stat="bin")) +
  geom_histogram(binwidth = 0.3)  +
  scale_x_continuous(limits = c(0,20)) +
  scale_y_continuous(limits = c(0,10000)) +
  theme(legend.title =element_blank()) +
  scale_fill_discrete(breaks = c("0","1"), labels = c("Unprotected area","Protected area"))
  theme_classic()

```

### 2.2

Create a plot that visualizes the relationship between the light intensity at night (night_lights_100) and the slope (hydro_slo_100). What could be a problem with a standard scatterplot? Try to solve this issue and briefly describe what you see.

```{r}
plot(quindio_grid$night_lights_100, quindio_grid$hydro_slo_100)

quindio_grid %>% 
  ggplot(aes(x=night_lights_100,y = hydro_slo_100, color = night_lights_100)) + 
  geom_point() +
  theme_classic()
```
Both the base R and the ggplot standard scatterplot do not adequately visualize the distribution since n is very large. This is why we reduce the size of the data points and make them a bit transparent.

```{r}

quindio_grid %>% 
  ggplot(aes(x=night_lights_100,y = hydro_slo_100, color = night_lights_100)) + 
  geom_point(alpha = 1/10, size = 0.5) +
  geom_smooth(color = "black") +
  theme_classic()

```

The plot suggests a negative relationship of the slope and the night lights. On average, more night lights coorelates with a slightly lower slope. This can also be checked with a simple linear regression:

```{r}
summary(lm(hydro_slo_100 ~ night_lights_100, quindio_grid))
```


# Random Forests and Boosted Regression Trees

## Exercise 3

### 3.1

Use the input data for Colombia on the municipal level (colombia_input.fst) to train a Random Forest. Use the log of the population density (raster_pop_100) as the dependent colombia_input.fst variable. Tune one of the parameters in the Random Forest. Briefly describe the parameter you are tuning and explain why you have decided for this parameter.

```{r}

col_input <- col_input %>% 
  mutate(raster_pop_100_log = log(raster_pop_100))

rf_1 <- ranger(data = col_input, dependent.variable.name = "raster_pop_100_log", importance = "impurity")

class(rf_1)
```
```{r}
control = trainControl(method = "cv", number = 5)

```
 
### 3.2

Use the best Random Forest model from the tuning exercise to make a prediction of the grid-level population density in Quindío. Make sure that the sums of the grid-level predictions match the official numbers on the municipal level.

## Exercise 4

### 4.1

Use the input data for Colombia on the municipal level (colombia_input.fst) to train a Boosted Regression Tree. Use the log of the population density (raster_pop_100) as the dependent variable. Tune one of the parameters in the Boosted Regression Tree. Briefly describe the parameter you are tuning and explain why you have decided for this parameter.

### 4.2

Use the best Boosted Regression Tree model from the tuning exercise to make a prediction of the grid-level population density in Quindío. Make sure that the sums of the grid-level predictions match the official numbers on the municipal level.

# Visualization of Results

## Exercise 5

Create a plot showing the following three maps of the population density in Quindío side by side: one based on the input data, one based on your Random Forest prediction, and one based on your Boosted Regression Tree prediction. Try to make sure that the maps give a good picture of the differences in population density, both between the different data sets as well as between the different parts of the department.





<br>
<br>
<br>
<br>

