---
title: "Equality of Opportunity Seminar Paper"
author: "Leonard Fidlin, Daniel Jost, Anne Valder"
date: "14 1 2021"
bibliography: bibliography.bib
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
subtitle: Data Science and Machine Learning 2187 & 2087
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
```

# **Introduction**
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
library(rpart)
library(rpart.plot) 
# library(precrec)
library(caret)       
library(party)
library(partykit)# Ctree
library(ggparty)
library(tidyverse)
# library(vcd)
library(RColorBrewer)
library(knitr)
# library(robustHD) # Winsorize Function
# library(glmnet)  
# library(haven)
# library(fst)
# library(ranger)
# library(tuneRanger)
# library(xgboost)
library(readr)
library(summarytools)
```
# **Data Wrangling**
We use the EU-SILC data from 2011 as it was the survey when additionally there were questions on inter-generational transmission. These were questions on the parents of the respondents. We want to see, whether it is possible using only the information given about the parents to predict the correct income of the respondents and what the outstanding circumstances are for the trees we grow.

The unique identifier used in all  four data sets is the household ID identifier: RX030 in the Personal Register, PX030 in the Personal Data, DB030 in the Household Register, and HB030 in the Household Data file.

We use the following variables for circumstances: Respondent's sex (PB150), Respondent's country of birth (Citizenship? PB220A), Presence of parents at home (PT010), Number of adults (18 or older) in respondents household (PT020), Number of working adults (18 or older) in respondents household (PT030), Father/Mother country of birth and citizenship (PT060, PT070, PT090, PT100), Father/mother education (PT110, PT120), Father/mother occupational status (PT130, PT160), Father/mother main occupation (PT150,PT180), Managerial position of father/mother(PT140,PT170), Tenancy status of the house in which respondent was living as a child (PT210).

Outcome Variables i.e. Income: Total Household gross income (HY010), Total Disposable Income (HY020), Dwelling Type (HH010), Housing (HH030).

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
# setting the data path
data_path ="./SILC_2011"
getwd()

# accessing the data
AT_personal_data <- read.csv(file.path(data_path, "AT_2011p_EUSILC.csv"))
AT_household_data <- read.csv(file.path(data_path, "AT_2011h_EUSILC.csv"))

# change the name of the identifier variable
AT_household_data <- AT_household_data %>% rename("PX030" = HB030)

# joining the data
AT_equality_data <- AT_personal_data %>%  left_join(AT_household_data, by = "PX030")

# Renaming important variables for readability of tree
AT_equality_data <- AT_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
```                                                                                                                                           

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

print(dfSummary(AT_equality_data), method="render")

```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
# Here we repeat the Data Wrangling steps for other EU Member States
# France
FR_personal_data <- read.csv(file.path(data_path, "FR_2011p_EUSILC.csv"))
FR_household_data <- read.csv(file.path(data_path, "FR_2011h_EUSILC.csv"))
FR_household_data <- FR_household_data %>% rename("PX030" = HB030)
FR_equality_data <- FR_personal_data %>%  left_join(FR_household_data, by = "PX030")

FR_equality_data <- FR_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
# Denmark
DK_personal_data <- read.csv(file.path(data_path, "DK_2011p_EUSILC.csv"))
DK_household_data <- read.csv(file.path(data_path, "DK_2011h_EUSILC.csv"))
DK_household_data <- DK_household_data %>% rename("PX030" = HB030)
DK_equality_data <- DK_personal_data %>%  left_join(DK_household_data, by = "PX030")

DK_equality_data <- DK_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
# Spain
ES_personal_data <- read.csv(file.path(data_path, "ES_2011p_EUSILC.csv"))
ES_household_data <- read.csv(file.path(data_path, "ES_2011h_EUSILC.csv"))
ES_household_data <- ES_household_data %>% rename("PX030" = HB030)
ES_equality_data <- ES_personal_data %>%  left_join(ES_household_data, by = "PX030")

ES_equality_data <- ES_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
# Finland
FI_personal_data <- read.csv(file.path(data_path, "FI_2011p_EUSILC.csv"))
FI_household_data <- read.csv(file.path(data_path, "FI_2011h_EUSILC.csv"))
FI_household_data <- FI_household_data %>% rename("PX030" = HB030)
FI_equality_data <- FI_personal_data %>%  left_join(FI_household_data, by = "PX030")

FI_equality_data <- FI_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
# Italy
IT_personal_data <- read.csv(file.path(data_path, "IT_2011p_EUSILC.csv"))
IT_household_data <- read.csv(file.path(data_path, "IT_2011h_EUSILC.csv"))
IT_household_data <- IT_household_data %>% rename("PX030" = HB030)
IT_equality_data <- IT_personal_data %>%  left_join(IT_household_data, by = "PX030")

IT_equality_data <- IT_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)
# # Bulgaria
# BG_personal_data <- read.csv(file.path(data_path, "BG_2011p_EUSILC.csv"))
# BG_household_data <- read.csv(file.path(data_path, "BG_2011h_EUSILC.csv"))
# BG_household_data <- BG_household_data %>% rename("PX030" = HB030)
# BG_equality_data <- BG_personal_data %>%  left_join(BG_household_data, by = "PX030")
# 
# BG_equality_data <- BG_equality_data %>% select(
#   PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
#     age = (2011 - PB140), log_income = log(HY010 + 1)
#   ) %>% filter(
#     age %in% (27:59)
#   ) %>% mutate(
#     citizenship = factor(PB220A, labels = c(1,2,3))
#   ) %>% 
#   rename(
#     "year_of_birth" = PB140,
#     "annual_income" = HY010,
#     "sex" = PB150,
#     "parents_present" = PT010,
#     "adults_home" = PT020,
#     "children_home" = PT030,
#     "father_cob" = PT060,
#     "father_cit" = PT070,
#     "mother_cob" = PT090,
#     "mother_cit" = PT100,
#     "father_edu" = PT110,
#     "mother_edu" = PT120,
#     "father_occup_stat" = PT130,
#     "mother_occup_stat" = PT160,
#     "father_occup" = PT150,
#     "mother_occup" = PT180,
#     "father_manag" = PT140,
#     "mother_manag" = PT170,
#     "tenancy" = PT210,
#     "monthly_income" = PY200G)
# Latvia
LV_personal_data <- read.csv(file.path(data_path, "LV_2011p_EUSILC.csv"))
LV_household_data <- read.csv(file.path(data_path, "LV_2011h_EUSILC.csv"))
LV_household_data <- LV_household_data %>% rename("PX030" = HB030)
LV_equality_data <- LV_personal_data %>%  left_join(LV_household_data, by = "PX030")

LV_equality_data <- LV_equality_data %>% select(
  PB140, HY010, PB150, PB220A, PT010, PT020, PT030, PT060, PT070, PT090, PT100, PT110, PT120, PT130, PT160, PT150, PT180, PT140, PT170, PT210, PY200G) %>% mutate(
    age = (2011 - PB140), log_income = log(HY010 + 1)
  ) %>% filter(
    age %in% (27:59)
  ) %>% mutate(
    citizenship = factor(PB220A, labels = c(1,2,3))
  ) %>% 
  rename(
    "year_of_birth" = PB140,
    "annual_income" = HY010,
    "sex" = PB150,
    "parents_present" = PT010,
    "adults_home" = PT020,
    "children_home" = PT030,
    "father_cob" = PT060,
    "father_cit" = PT070,
    "mother_cob" = PT090,
    "mother_cit" = PT100,
    "father_edu" = PT110,
    "mother_edu" = PT120,
    "father_occup_stat" = PT130,
    "mother_occup_stat" = PT160,
    "father_occup" = PT150,
    "mother_occup" = PT180,
    "father_manag" = PT140,
    "mother_manag" = PT170,
    "tenancy" = PT210,
    "monthly_income" = PY200G)

```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

print(dfSummary(FR_equality_data), method="render")


print(dfSummary(DK_equality_data), method="render") #We have maybe too many missing values for Denmark


print(dfSummary(ES_equality_data), method="render")


print(dfSummary(FI_equality_data), method="render") #We have maybe too many missing values for Finland


print(dfSummary(IT_equality_data), method="render")


print(dfSummary(LV_equality_data), method="render")

```

# **Method**: Conditional Inference Trees

* `ctree` from party package in R
* recursive partitioning just like `rpart`
* `rpart`: maximizing an information measure
* `ctree`: significance test procedure

### Advantages

**Advantages of Trees:** straightforward to interpret

**Advantages of Trees over linear regression models:** very large set of observations can be used & model speciﬁcation is no longer exogenously given

**Advantages of Conditional Inference Trees over Regression and Classification Trees (CART):** the algorithm automatically provides a test for the null hypothesis of equality of opportunity & prevents overfitting while CART "cannot distinguish between a significant and an insignificant improvement in the information measure" (Mingers 1987, as cited in @hot, 2) & consider the distributional properties of the measures.


### Procedure 

The algorithm follows a stepwise procedure [@brunori20, 7-8]:

1. **Choose confidence level**
2. **Choose feature:** test all the null hypotheses of independence between the individual outcome and each of all the observable circumstances
    i) no hypothesis can be rejected: stop
    ii) one or more circumstance is siginificant: select the circumstance with the smallest p-value and proceed
3. **Choose split:** for every possible way the selected circumstance can divide the sample into two subgroups, test the hypothesis of same mean outcome in the two resulting subgroups. Choose the splitting point with the smallest p-value
4. **Repeat :)**


# **Results**
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
set.seed(123)

AT_equality_data <- AT_equality_data %>%
  mutate(train_index = sample(c("train", "test"), nrow(AT_equality_data), replace=TRUE, prob=c(0.7, 0.3)))

AT_train <- AT_equality_data %>% filter(train_index=="train")
AT_test <- AT_equality_data %>% filter(train_index=="test")

formula <- log_income ~ sex + citizenship + parents_present + adults_home + children_home + father_cob + father_cit + mother_cob + mother_cit + father_edu + mother_edu + father_occup_stat + mother_occup_stat + father_occup + mother_occup + father_manag + mother_manag + tenancy

AT_tree <- rpart(formula, data = AT_train, cp=.005)

AT_tree

rpart.plot(AT_tree, box.palette="RdBu", nn=FALSE, type=2)

```
*Confusion Matrix
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
AT_test$prediction_tree <- predict(AT_tree, newdata = AT_test, type = c("matrix"))

class(AT_test$prediction_tree)
levels(AT_test$prediction_tree)

confusion <- confusionMatrix(AT_test$log_income, AT_test$prediction_tree, mode="everything")
confusion
```
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
set.seed(1786)

FR_equality_data <- FR_equality_data %>%
  mutate(train_index = sample(c("train", "test"), nrow(FR_equality_data), replace=TRUE, prob=c(0.7, 0.3)))

FR_train <- FR_equality_data %>% filter(train_index=="train")
FR_test <- FR_equality_data %>% filter(train_index=="test")

formula <- log_income ~ sex + citizenship + parents_present + adults_home + children_home + father_cob + father_cit + mother_cob + mother_cit + father_edu + mother_edu + father_occup_stat + mother_occup_stat + father_occup + mother_occup + father_manag + mother_manag + tenancy

FR_tree <- rpart(formula, data = FR_train, cp=.005)

FR_tree

rpart.plot(FR_tree, box.palette="RdBu", nn=FALSE, type=2)
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
ES_equality_data <- ES_equality_data %>%
  mutate(train_index = sample(c("train", "test"), nrow(ES_equality_data), replace=TRUE, prob=c(0.7, 0.3)))

ES_train <- ES_equality_data %>% filter(train_index=="train")
ES_test <- ES_equality_data %>% filter(train_index=="test")

formula <- log_income ~ sex + citizenship + parents_present + adults_home + children_home + father_cob + father_cit + mother_cob + mother_cit + father_edu + mother_edu + father_occup_stat + mother_occup_stat + father_occup + mother_occup + father_manag + mother_manag + tenancy

ES_tree <- rpart(formula, data = ES_train, cp=.005)

ES_tree

rpart.plot(ES_tree, box.palette="RdBu", nn=FALSE, type=2)
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
control <- trainControl(method = "repeatedcv", number = 10, repeats = 10, savePredictions = T, classProbs = T, summaryFunction = multiClassSummary)

tuning_grid <- expand.grid(cp = seq(0, 0.02, by= 0.005))
tuning_grid

tree_caret <- train(data = equality_data, formula, method = "rpart", trControl = control, tuneGrid = tuning_grid, metric = "Accuracy", na.action = na.pass)
tree_caret
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
set.seed(456)

AT_Ctree <- ctree(formula, data = AT_train)
AT_Ctree

plot(AT_Ctree, type = "simple",gp = gpar(fontsize = 6),
  inner_panel=node_inner,
  ip_args=list(abbreviate = TRUE,id = FALSE), main = "Conditional Inference Tree for Austria 2011")

```
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

set.seed(789)

FR_Ctree <- ctree(formula, data = FR_train)
FR_Ctree

plot(FR_Ctree, type = "simple",gp = gpar(fontsize = 6),
  inner_panel=node_inner,
  ip_args=list(abbreviate = TRUE,id = FALSE), main = "Conditional Inference Tree for France 2011")


```
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
set.seed(19823)
ES_Ctree <- ctree(formula, data = ES_train)
ES_Ctree

plot(ES_Ctree, type = "simple",gp = gpar(fontsize = 6),
  inner_panel=node_inner,
  ip_args=list(abbreviate = TRUE,id = FALSE), main = "Conditional Inference Tree for Spain 2011")
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
IT_Ctree <- ctree(formula, data = IT_train)
IT_Ctree

plot(IT_Ctree, type = "simple",gp = gpar(fontsize = 6),
  inner_panel=node_inner,
  ip_args=list(abbreviate = TRUE,id = FALSE), main = "Conditional Inference Tree for Italy 2011")
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
LV_Ctree <- ctree(formula, data = LV_train)
LV_Ctree

plot(LV_Ctree, type = "simple",gp = gpar(fontsize = 6),
  inner_panel=node_inner,
  ip_args=list(abbreviate = TRUE,id = FALSE), main = "Conditional Inference Tree for Latvia 2011")
```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

```

```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}

```

# **Conclusion**
=======
# **Conclusion**

# **References**
>>>>>>> 8860f3d4dd72f45073c60dda2f3226dd505e53a1