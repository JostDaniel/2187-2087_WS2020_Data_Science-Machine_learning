---
title: "AT2019 Data Wrangling"
author: "Daniel Jost"
date: "1/31/2021"
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
subtitle: Data Science and Machine Learning 2187 & 2087
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
```

** To Do's **

Adapt new data to the Graphs and Summary Statistics

CV, Training and Test Data,
Train with Caret package
Random forrest of Inference Tree, and/or a Boosted Regression Tree
Confusion Matrix, ROC etc.
Graphs

Apply the Data Wrangling Stept to the Synthetic EU Silc data
Combine all the data in one RMD file - Dont Confuse names

Compare Cross-Country Results


**Libraries**
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
library(tidyverse)
library(readr)          # import
library(rpart)          # regression trees
library(rpart.plot)     # regression tree plots
library(summarytools)   # summary statistics
library(party)          # ctree

# library(precrec)
library(caret)       
# library(party)
# library(partykit)
# library(vcd)
# library(RColorBrewer)
# library(knitr)
# library(glmnet)  
# library(haven)
# library(fst)
# library(ranger)
# library(tuneRanger)
# library(xgboost)
```

**Data import**
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
# setting the data path
data_path ="./AT2019"

# accessing the data
data19_p <- read.csv(file.path(data_path, "p_silc2019_ext.csv"), sep = ";")  # personal data
# data19_pID <- read.csv(file.path(data_path, "id_schluessel_r_ext.csv"), sep = ";")  # personal ID
# data19_h <- read.csv(file.path(data_path, "h_silc2019_ext.csv"), sep = ";")  # household data
# data19_hID <- read.csv(file.path(data_path, "id_schluessel_d_ext.csv"), sep = ";")  # household ID
```

**Data Wrangling**
```{r echo=T, message=FALSE, error=FALSE, warning=FALSE}
# Renaming important variables for readability of tree

# "no_parents_present" = M002000, "with_other_adults" = M001500
# recode age, sex, und ??? staatsburgerschaft 


data19 <- data19_p %>% 
  select(sex, P038004, P110000nu, P111010nu, alter, M009010, M010000, M014000, M016000, M017000, M020010, M021000, M025000, M027000, M028000, M004000, M001300, M001510, M003100, M001100, M001200, M002000, M001500) %>% 
  rename("inc_net" = P038004,               # net income per month of respondent
         "country_birth" = P110000nu,               # country of birth of respondent
         "citizenship" = P111010nu,         # citizenship of respondent
         "age" = alter,                     # age of respondent
         #"father_birth" = ????,            # country of birth of father at age 14
         "father_cit" = M009010,            # citizenship of father at age 14
         "father_edu" = M010000,            # education of father at age 14 (höchster abschluss)
         "father_occup_stat" = M014000,            # occupational status of father at age 14
         "father_occup" = M016000,          # main occupation of father at age 14
         "father_manag" = M017000,          # managerial position of father at age 14
         #"mother_birth" = ????,            # country of birth of mother at age 14
         "mother_cit" = M020010,            # citizenship of mother at age 14
         "mother_edu" = M021000,            # education of mother at age 14
         "mother_occup_stat" = M025000,     # occupational status of mother at age 14
         "mother_occup" = M027000,          # main occupation of mother at age 14
         "mother_manag" = M028000,          # managerial position of mother at age 14
         "tenancy" = M004000,               # tenancy at age 14
         "children" = M001300,              # number of children (under 18) in respondent’s household at age 14
         "adults" = M001510,                # number of adults (aged 18 or more) in respondent’s household
         "adults_working" = M003100, # number of working adults (aged 18 or more) in respondent’s household
         "father_present" = M001100,
         "mother_present" = M001200,
         ) %>%    # number of working adults (aged 18 or more) in respondent’s household
  filter(age %in% (27:59), inc_net >= 0, mother_present > 0, father_present > 0, father_cit > 0, mother_cit > 0)  %>%      # We drop all answers where the respondents refused or were not able to provide information
  mutate("inc_net_log" = log(inc_net),  "both_parents_present" = father_present + mother_present, # 4 = none present, 3 = one present, 2 = both present
         sex = factor(ifelse(as.numeric(sex)==2, 1,0)), 
         country_birth = factor(country_birth, labels = c(1, 2, 2, 2, 3, 3)), # Austria, EU, Non-EU
         father_cit = ifelse(father_cit == 1, 1, 2), # Austria and Other
         mother_cit = ifelse(mother_cit == 1, 1, 2))       # recode(country_birth, "1" = "Austria", "EU" = 2, "EU" = 3, "EU" = 4, "non-EU" = 5, "non-EU" = 6)) # logged net income per month of respondent
  
  # data19$sex<-factor(ifelse(as.numeric(data19$sex)==2, 1,0))   # recoding sex from (m=1, f=2) to (0, 1)

# We want to group Country of Birth  Answers 1 = Austria remains, Answer 2,3,4 are grouped as EU, and Answers 5,6 are grouped as outside EU
#, father_edu > 0, mother_edu > 0
```

**Data Exploration and Visualization**
The ad-hoc module on intergenerational transmission of disadvantages only includes "selected respondents aged over 24 years and less than 60 years". This is why we exclude them: coding '-6' means that year of birth is outside of 1969 and 1994 range or the interviw was a proxy interview. Additionally, we exclude all respondents that where not part of this ad-hoc modul even if of the desired age.  

mother/father_edu: -3: not applicable (no mother/father, mother/father not present....)

```{r}

print(dfSummary(data19), method="render")
```

Age pyramide
```{r}
# library("RColorBrewer")
# display.brewer.all()
data19 %>% 
ggplot(aes(x = age, fill=sex))  + 
  geom_bar(data = subset(data19, sex==1)) +
  geom_bar(data = subset(data19, sex==0), aes(y=..count..*(-1))) + 
  scale_x_continuous(breaks = seq(24,59,2), labels=abs(seq(25,59,2))) +
  scale_fill_manual(name = "Sex", labels = c("Male", "Female"), values=c("springgreen2", "slateblue1")) +
  labs(title = "Age pyramide of ad-hoc module on intergenerational transmission of disadvantages", x = "Age", y = "") +
  theme_bw() +
  coord_flip()

```


Correlation plot
```{r}
library(corrplot)
library(Hmisc)

class(data19)

rcorr <- rcorr(as.matrix(data19))

corrplot(rcorr, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```

**Regression Tree**
```{r}
formula = inc_net_log ~ country_birth + citizenship + father_cit + father_edu + father_occup_stat + father_occup + father_manag + mother_cit + mother_edu + mother_occup_stat + mother_occup + mother_manag + tenancy + children + adults + adults_working + father_present + mother_present + both_parents_present

data19 <- data19 %>%
  mutate(train_index = sample(c("train", "test"), nrow(data19), replace=TRUE, prob=c(0.8, 0.2)))

train <- data19 %>% filter(train_index=="train")
test <- data19 %>% filter(train_index=="test")

tree <- rpart(formula, data = train, cp=.005)
tree

rpart.plot(tree, box.palette="RdBu", nn=FALSE, type=2)
```
**Conditional inference tree**
```{r}
# For the Inference Tree to work, we must have all variables as numeric data
Ctree <- ctree(formula, data = train)
Ctree

plot(Ctree, gp = gpar(fontsize = 4),
  inner_panel=node_inner,
  ip_args=list(id = FALSE))
```